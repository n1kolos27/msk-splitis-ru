# ============================================
# Apache Configuration для msk.splitis.ru
# ============================================

# Включаем mod_rewrite
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /

  # Редирект с HTTP на HTTPS
  RewriteCond %{HTTPS} off
  RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  # Редирект с www на non-www (или наоборот)
  # Раскомментируйте нужный вариант
  # RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
  # RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

  # Убираем trailing slash (кроме директорий)
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_URI} (.+)/$
  RewriteRule ^ %1 [R=301,L]

  # Убираем расширение .html из URL (опционально)
  # RewriteCond %{REQUEST_FILENAME} !-f
  # RewriteCond %{REQUEST_FILENAME} !-d
  # RewriteCond %{REQUEST_FILENAME}.html -f
  # RewriteRule ^(.*)$ $1.html [L]
</IfModule>

# ============================================
# Заголовки безопасности
# ============================================

<IfModule mod_headers.c>
  # Защита от MIME-type sniffing
  Header set X-Content-Type-Options "nosniff"

  # Защита от clickjacking
  Header set X-Frame-Options "DENY"

  # Защита от XSS
  Header set X-XSS-Protection "1; mode=block"

  # Политика реферера
  Header set Referrer-Policy "strict-origin-when-cross-origin"

  # Политика разрешений
  Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"

  # Content Security Policy
  # Разрешаем необходимые ресурсы: Google Fonts, inline styles/scripts от Eleventy
  Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"

  # Strict Transport Security (HSTS) - только для HTTPS
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# ============================================
# Обработка ошибок
# ============================================

# Кастомная страница 404
ErrorDocument 404 /404.html

# Кастомная страница 500
ErrorDocument 500 /500.html

# ============================================
# Кэширование статических ресурсов
# ============================================

<IfModule mod_expires.c>
  ExpiresActive On

  # Изображения
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"

  # Шрифты
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType application/font-woff "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"

  # CSS и JavaScript
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType application/x-javascript "access plus 1 year"

  # HTML (не кэшируем для актуальности контента)
  ExpiresByType text/html "access plus 0 seconds"

  # JSON и XML
  ExpiresByType application/json "access plus 0 seconds"
  ExpiresByType application/xml "access plus 0 seconds"
  ExpiresByType text/xml "access plus 0 seconds"
</IfModule>

# ============================================
# Сжатие (Gzip)
# ============================================

<IfModule mod_deflate.c>
  # Сжимаем HTML, CSS, JavaScript, Text, XML и шрифты
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE image/svg+xml

  # Не сжимаем изображения (они уже сжаты)
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp)$ no-gzip dont-vary
</IfModule>

# ============================================
# MIME типы
# ============================================

<IfModule mod_mime.c>
  # JavaScript
  AddType application/javascript js
  AddType application/json json

  # Шрифты
  AddType font/woff woff
  AddType font/woff2 woff2
  AddType application/font-woff woff
  AddType application/font-woff2 woff2
  AddType font/ttf ttf
  AddType font/otf otf

  # Изображения
  AddType image/svg+xml svg svgz
  AddType image/webp webp

  # XML
  AddType application/xml xml
  AddType text/xml xml
</IfModule>

# ============================================
# Безопасность файлов
# ============================================

# Блокируем доступ к скрытым файлам
<FilesMatch "^\.">
  Order allow,deny
  Deny from all
</FilesMatch>

# Блокируем доступ к служебным файлам
<FilesMatch "(^\.htaccess|\.git|\.env|\.log|\.md|\.json|\.lock)$">
  Order allow,deny
  Deny from all
</FilesMatch>

# Разрешаем доступ к robots.txt и sitemap.xml
<FilesMatch "^robots\.txt$|^sitemap\.xml$">
  Order allow,deny
  Allow from all
</FilesMatch>

# ============================================
# Защита от hotlinking изображений (опционально)
# ============================================

# <IfModule mod_rewrite.c>
#   RewriteEngine on
#   RewriteCond %{HTTP_REFERER} !^$
#   RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?msk\.splitis\.ru [NC]
#   RewriteRule \.(jpg|jpeg|png|gif|svg)$ - [NC,F,L]
# </IfModule>

# ============================================
# Настройки производительности
# ============================================

# Отключаем ETags
<IfModule mod_headers.c>
  Header unset ETag
</IfModule>
FileETag None

# Увеличиваем лимит размера загружаемых файлов (если нужны формы)
# php_value upload_max_filesize 10M
# php_value post_max_size 10M

# ============================================
# Кодировка по умолчанию
# ============================================

AddDefaultCharset UTF-8

# ============================================
# Защита от directory listing
# ============================================

Options -Indexes

# ============================================
# Настройки для .well-known директории
# ============================================

# Разрешаем доступ к файлам в .well-known (необходимо для Let's Encrypt)
<IfModule mod_rewrite.c>
  RewriteCond %{REQUEST_URI} ^\.well-known/
  RewriteRule ^ - [L]
</IfModule>