# Настройка GitHub Actions для автоматического деплоя

## Что было сделано:

1. ✅ Создан workflow файл `.github/workflows/deploy.yml`
2. ✅ Настроен автоматический деплой при пуше в ветку `main`
3. ✅ Первый production деплой выполнен успешно

## Настройка GitHub Secrets

Для работы автоматического деплоя нужно добавить секреты в GitHub:

### Шаг 1: Откройте настройки репозитория

1. Перейдите в репозиторий: https://github.com/n1kolos27/msk-splitis-ru
2. Нажмите **Settings** (Настройки)
3. В левом меню выберите **Secrets and variables** → **Actions**
4. Нажмите **New repository secret**

### Шаг 2: Добавьте следующие секреты:

#### 1. SSH_HOST
- **Name:** `SSH_HOST`
- **Value:** `91.200.150.96`
- **Description:** IP-адрес сервера Timeweb Cloud

#### 2. SSH_USER
- **Name:** `SSH_USER`
- **Value:** `root`
- **Description:** Пользователь для SSH подключения

#### 3. SSH_PRIVATE_KEY
- **Name:** `SSH_PRIVATE_KEY`
- **Value:** Содержимое приватного SSH-ключа (см. ниже)
- **Description:** Приватный SSH-ключ для подключения к серверу

### Шаг 3: Получение приватного ключа

Приватный ключ находится в файле:
`C:\Users\USER\.ssh\id_ed25519_timeweb`

**ВАЖНО:** 
- Скопируйте ВСЁ содержимое файла, включая строки:
  - `-----BEGIN OPENSSH PRIVATE KEY-----`
  - Все строки ключа
  - `-----END OPENSSH PRIVATE KEY-----`

### Шаг 4: Проверка настройки

После добавления секретов:

1. Сделайте тестовый коммит и пуш в ветку `main`
2. Перейдите в раздел **Actions** в GitHub
3. Проверьте, что workflow запустился автоматически
4. Убедитесь, что деплой прошел успешно

## Как работает автоматический деплой:

1. **Push в ветку `main`** → GitHub Actions автоматически запускается
2. **Checkout кода** → Клонируется репозиторий
3. **Установка зависимостей** → `npm ci` (чистая установка)
4. **Сборка проекта** → `npm run build` (создается `_site/`)
5. **Копирование файлов** → Файлы из `_site/` копируются на сервер через SCP
6. **Установка прав** → Права доступа устанавливаются для Nginx
7. **Перезагрузка Nginx** → Сервер перезагружается для применения изменений

## Ручной запуск деплоя

Если нужно запустить деплой вручную:

1. Перейдите в раздел **Actions** в GitHub
2. Выберите workflow **"Deploy to Timeweb Cloud Production"**
3. Нажмите **"Run workflow"**
4. Выберите ветку `main`
5. Нажмите **"Run workflow"**

## Мониторинг деплоя

После каждого деплоя проверьте:

- ✅ Логи в разделе **Actions** не содержат ошибок
- ✅ Сайт доступен: `http://msk.splitis.ru`
- ✅ Файлы обновились на сервере
- ✅ Nginx перезагрузился успешно

## Структура workflow

Workflow файл: `.github/workflows/deploy.yml`

**Триггеры:**
- Автоматически при пуше в `main`
- Вручную через `workflow_dispatch`

**Шаги:**
1. Checkout кода
2. Setup Node.js 20
3. Install dependencies (`npm ci`)
4. Build project (`npm run build`)
5. Deploy via SCP
6. Set permissions
7. Reload Nginx
8. Verify deployment

## Безопасность

- ✅ Приватный SSH-ключ хранится в GitHub Secrets (зашифрован)
- ✅ Ключ не попадает в репозиторий
- ✅ Доступ к секретам имеют только администраторы репозитория

## Troubleshooting

### Ошибка: "Host key verification failed"
- Убедитесь, что SSH-ключ добавлен на сервер
- Проверьте, что `SSH_HOST` и `SSH_USER` указаны правильно

### Ошибка: "Permission denied"
- Проверьте, что приватный ключ скопирован полностью (включая BEGIN/END строки)
- Убедитесь, что ключ имеет правильный формат

### Ошибка: "Connection refused"
- Проверьте, что сервер доступен по IP `91.200.150.96`
- Убедитесь, что порт 22 открыт

---

**Готово к использованию!** После добавления секретов в GitHub, каждый push в `main` будет автоматически деплоить проект на production сервер.

